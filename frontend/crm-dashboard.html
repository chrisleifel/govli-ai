<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Dashboard - Govli AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN production warning
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0]?.includes?.('cdn.tailwindcss.com should not be used in production')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
        })();
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --deep-ocean: #0a1628;
            --ocean-dark: #0c4a6e;
            --ocean-primary: #0369a1;
            --azure-blue: #0284c7;
            --sky-blue: #0ea5e9;
            --cyan-bright: #06b6d4;
            --teal-accent: #14b8a6;
            --emerald-success: #10b981;
            --glass-bg: rgba(15, 23, 42, 0.75);
            --glass-border: rgba(6, 182, 212, 0.25);
            --glow-cyan: rgba(6, 182, 212, 0.4);
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg,
                #0a1628 0%,
                #0c2340 25%,
                #0e3a5f 50%,
                #1e3a5f 75%,
                #164e7f 100%
            );
            min-height: 100vh;
            position: relative;
        }

        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(6, 182, 212, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(20, 184, 166, 0.06) 0%, transparent 50%);
            pointer-events: none;
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .glass-hover:hover {
            background: rgba(15, 23, 42, 0.85);
            border-color: var(--cyan-bright);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--azure-blue) 0%, var(--ocean-primary) 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
        }

        .nav-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 16px 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(20, 184, 166, 0.1) 100%);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--cyan-bright);
            transform: translateY(-4px);
        }

        .contact-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .contact-card:hover {
            border-color: var(--cyan-bright);
            background: rgba(255, 255, 255, 0.08);
        }

        .tab-button {
            padding: 12px 24px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.6);
        }

        .tab-button.active {
            border-bottom-color: var(--cyan-bright);
            color: white;
        }

        .tab-button:hover {
            background: rgba(6, 182, 212, 0.1);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-active { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .badge-inactive { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        .badge-citizen { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .badge-business { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        .badge-contractor { background: rgba(234, 179, 8, 0.2); color: #facc15; }
        .badge-vendor { background: rgba(236, 72, 153, 0.2); color: #f472b6; }

        .input-field {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--cyan-bright);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .interaction-item {
            background: rgba(15, 23, 42, 0.3);
            border-left: 3px solid var(--cyan-bright);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--glass-border);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-dot {
            position: absolute;
            left: -25px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--cyan-bright);
            border: 3px solid var(--deep-ocean);
        }
    </style>
</head>
<body>
    <div class="gradient-bg">

        <!-- Navigation Header -->
        <div class="nav-header">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-address-book text-3xl" style="color: var(--cyan-bright);"></i>
                    <span class="text-2xl font-bold text-white">CRM Dashboard</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showImportModal()" class="px-4 py-2 rounded-lg border border-cyan-400 hover:bg-cyan-400/10 transition">
                        <i class="fas fa-file-import mr-2"></i>Import
                    </button>
                    <button onclick="exportContacts()" class="px-4 py-2 rounded-lg border border-cyan-400 hover:bg-cyan-400/10 transition">
                        <i class="fas fa-file-export mr-2"></i>Export
                    </button>
                    <button onclick="showCreateContactModal()" class="btn-primary">
                        <i class="fas fa-plus mr-2"></i>New Contact
                    </button>
                    <button onclick="window.location.href='index.html'" class="px-4 py-2 rounded-lg border border-gray-600 hover:border-cyan-400 transition">
                        <i class="fas fa-home"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="px-8 py-8">

            <!-- Stats Row -->
            <div class="grid grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-users text-3xl text-cyan-400"></i>
                        <span id="totalContacts" class="text-3xl font-bold text-white">0</span>
                    </div>
                    <p class="text-gray-300 text-sm">Total Contacts</p>
                </div>
                <div class="stat-card">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-comments text-3xl text-teal-400"></i>
                        <span id="totalInteractions" class="text-3xl font-bold text-white">0</span>
                    </div>
                    <p class="text-gray-300 text-sm">Total Interactions</p>
                </div>
                <div class="stat-card">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-user-plus text-3xl text-green-400"></i>
                        <span id="newThisMonth" class="text-3xl font-bold text-white">0</span>
                    </div>
                    <p class="text-gray-300 text-sm">New This Month</p>
                </div>
                <div class="stat-card">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-star text-3xl text-yellow-400"></i>
                        <span id="avgLeadScore" class="text-3xl font-bold text-white">0</span>
                    </div>
                    <p class="text-gray-300 text-sm">Avg Lead Score</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="glass rounded-t-xl">
                <div class="flex border-b border-gray-700">
                    <button class="tab-button active" onclick="switchTab('contacts')" id="tab-contacts">
                        <i class="fas fa-address-card mr-2"></i>Contacts
                    </button>
                    <button class="tab-button" onclick="switchTab('interactions')" id="tab-interactions">
                        <i class="fas fa-history mr-2"></i>Interactions
                    </button>
                    <button class="tab-button" onclick="switchTab('duplicates')" id="tab-duplicates">
                        <i class="fas fa-copy mr-2"></i>Duplicates
                    </button>
                </div>
            </div>

            <!-- Contacts Tab -->
            <div id="content-contacts" class="glass rounded-b-xl p-6">

                <!-- Filters -->
                <div class="mb-6">
                    <div class="flex items-center space-x-4">
                        <input type="text" id="searchContacts" placeholder="Search contacts..."
                               class="input-field flex-1" onkeyup="searchContacts()">
                        <select id="contactTypeFilter" class="input-field" onchange="filterContacts()">
                            <option value="">All Types</option>
                            <option value="citizen">Citizen</option>
                            <option value="business">Business</option>
                            <option value="contractor">Contractor</option>
                            <option value="vendor">Vendor</option>
                            <option value="government">Government</option>
                        </select>
                        <select id="statusFilter" class="input-field" onchange="filterContacts()">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>

                <!-- Contacts List -->
                <div id="contactsList" class="grid grid-cols-3 gap-4 mb-6">
                    <!-- Contacts will be loaded here -->
                </div>

                <!-- Pagination -->
                <div id="contactsPagination" class="flex justify-center items-center space-x-2">
                    <!-- Pagination will be rendered here -->
                </div>

            </div>

            <!-- Interactions Tab -->
            <div id="content-interactions" class="glass rounded-b-xl p-6 hidden">

                <!-- Filters -->
                <div class="mb-6">
                    <div class="flex items-center space-x-4">
                        <select id="interactionTypeFilter" class="input-field" onchange="filterInteractions()">
                            <option value="">All Types</option>
                            <option value="email">Email</option>
                            <option value="phone_call">Phone Call</option>
                            <option value="meeting">Meeting</option>
                            <option value="permit_application">Permit Application</option>
                            <option value="inspection">Inspection</option>
                        </select>
                    </div>
                </div>

                <!-- Interactions List -->
                <div id="interactionsList" class="space-y-3 mb-6">
                    <!-- Interactions will be loaded here -->
                </div>

                <!-- Pagination -->
                <div id="interactionsPagination" class="flex justify-center items-center space-x-2">
                    <!-- Pagination will be rendered here -->
                </div>

            </div>

            <!-- Duplicates Tab -->
            <div id="content-duplicates" class="glass rounded-b-xl p-6 hidden">
                <div class="text-center py-12">
                    <i class="fas fa-search text-6xl text-gray-600 mb-4"></i>
                    <p class="text-gray-400 mb-4">Select a contact to find potential duplicates</p>
                    <button onclick="switchTab('contacts')" class="btn-primary">
                        Browse Contacts
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Contact Detail Modal -->
    <div id="contactModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-8 max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 id="modalContactName" class="text-3xl font-bold text-white mb-2"></h2>
                    <p id="modalContactType" class="text-gray-400"></p>
                </div>
                <button onclick="closeModal('contactModal')" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Contact Info -->
            <div id="contactInfo" class="grid grid-cols-2 gap-6 mb-8">
                <!-- Will be populated -->
            </div>

            <!-- Tabs for Details/Interactions/History -->
            <div class="flex border-b border-gray-700 mb-6">
                <button class="tab-button active" onclick="switchContactTab('details')" id="contact-tab-details">
                    Details
                </button>
                <button class="tab-button" onclick="switchContactTab('interactions')" id="contact-tab-interactions">
                    Interactions
                </button>
                <button class="tab-button" onclick="switchContactTab('permits')" id="contact-tab-permits">
                    Permits
                </button>
            </div>

            <div id="contact-content-details">
                <!-- Additional details -->
            </div>

            <div id="contact-content-interactions" class="hidden">
                <div class="mb-4 flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-white">Interaction History</h3>
                    <button onclick="showLogInteractionModal()" class="btn-primary">
                        <i class="fas fa-plus mr-2"></i>Log Interaction
                    </button>
                </div>
                <div id="contactInteractionsList" class="timeline">
                    <!-- Timeline will be populated -->
                </div>
            </div>

            <div id="contact-content-permits" class="hidden">
                <div id="contactPermitsList">
                    <!-- Permits will be populated -->
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-700">
                <div class="space-x-3">
                    <button onclick="editContact()" class="px-4 py-2 rounded-lg border border-cyan-400 hover:bg-cyan-400/10">
                        <i class="fas fa-edit mr-2"></i>Edit
                    </button>
                    <button onclick="findDuplicates()" class="px-4 py-2 rounded-lg border border-yellow-400 hover:bg-yellow-400/10">
                        <i class="fas fa-copy mr-2"></i>Find Duplicates
                    </button>
                    <button onclick="archiveContact()" class="px-4 py-2 rounded-lg border border-red-400 hover:bg-red-400/10">
                        <i class="fas fa-archive mr-2"></i>Archive
                    </button>
                </div>
                <button onclick="closeModal('contactModal')" class="px-6 py-2 rounded-lg border border-gray-600 hover:border-cyan-400">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Create/Edit Contact Modal -->
    <div id="createContactModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-white mb-6">Create New Contact</h2>

            <form id="contactForm" class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">First Name *</label>
                        <input type="text" id="firstName" class="input-field w-full" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Last Name *</label>
                        <input type="text" id="lastName" class="input-field w-full" required>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                        <input type="email" id="email" class="input-field w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Phone</label>
                        <input type="tel" id="phone" class="input-field w-full">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Contact Type *</label>
                        <select id="contactType" class="input-field w-full" required>
                            <option value="citizen">Citizen</option>
                            <option value="business">Business</option>
                            <option value="contractor">Contractor</option>
                            <option value="vendor">Vendor</option>
                            <option value="government">Government</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Organization</label>
                        <input type="text" id="organization" class="input-field w-full">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Address</label>
                    <input type="text" id="address" class="input-field w-full">
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">City</label>
                        <input type="text" id="city" class="input-field w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">State</label>
                        <input type="text" id="state" class="input-field w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Zip Code</label>
                        <input type="text" id="zipCode" class="input-field w-full">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Notes</label>
                    <textarea id="notes" rows="4" class="input-field w-full"></textarea>
                </div>

                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" onclick="closeModal('createContactModal')"
                            class="px-6 py-2 rounded-lg border border-gray-600 hover:border-cyan-400">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary px-8">
                        Create Contact
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Log Interaction Modal -->
    <div id="logInteractionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-8 max-w-2xl w-full">
            <h2 class="text-2xl font-bold text-white mb-6">Log Interaction</h2>

            <form id="interactionForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Type *</label>
                        <select id="interactionType" class="input-field w-full" required>
                            <option value="email">Email</option>
                            <option value="phone_call">Phone Call</option>
                            <option value="meeting">Meeting</option>
                            <option value="permit_application">Permit Application</option>
                            <option value="inspection">Inspection</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Direction *</label>
                        <select id="interactionDirection" class="input-field w-full" required>
                            <option value="inbound">Inbound</option>
                            <option value="outbound">Outbound</option>
                            <option value="system">System</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Subject</label>
                    <input type="text" id="interactionSubject" class="input-field w-full">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Content</label>
                    <textarea id="interactionContent" rows="6" class="input-field w-full"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Outcome</label>
                    <select id="interactionOutcome" class="input-field w-full">
                        <option value="successful">Successful</option>
                        <option value="unsuccessful">Unsuccessful</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" onclick="closeModal('logInteractionModal')"
                            class="px-6 py-2 rounded-lg border border-gray-600 hover:border-cyan-400">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary px-8">
                        Log Interaction
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-8 max-w-2xl w-full">
            <h2 class="text-2xl font-bold text-white mb-6">Import Contacts</h2>

            <div class="space-y-4">
                <p class="text-gray-400">Upload a CSV file with contact information. Required columns: firstName, lastName, email</p>

                <div class="border-2 border-dashed border-cyan-400/40 rounded-lg p-8 text-center cursor-pointer hover:border-cyan-400 transition"
                     onclick="document.getElementById('csvFile').click()">
                    <i class="fas fa-file-csv text-5xl text-cyan-400 mb-4"></i>
                    <p class="text-white mb-2">Click to upload CSV file</p>
                    <input type="file" id="csvFile" class="hidden" accept=".csv" onchange="handleCSVUpload(event)">
                </div>

                <div id="importPreview" class="hidden">
                    <h3 class="text-lg font-semibold text-white mb-2">Preview</h3>
                    <div class="bg-gray-900/50 rounded p-4 max-h-60 overflow-y-auto">
                        <pre id="csvPreviewText" class="text-sm text-gray-300"></pre>
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-8">
                <button onclick="closeModal('importModal')"
                        class="px-6 py-2 rounded-lg border border-gray-600 hover:border-cyan-400">
                    Cancel
                </button>
                <button onclick="importCSV()" id="importButton" disabled
                        class="btn-primary px-8 opacity-50">
                    Import Contacts
                </button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="crm.js"></script>
    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentTab = 'contacts';
        let currentContactTab = 'details';
        let currentPage = 1;
        let contactsData = [];
        let interactionsData = [];
        let currentContact = null;
        let csvData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadStats();
            await loadContacts();
            await loadInteractions();

            // Setup form submissions
            document.getElementById('contactForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createContact();
            });

            document.getElementById('interactionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await logInteraction();
            });
        });

        // Load statistics
        async function loadStats() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/crm/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('totalContacts').textContent = stats.totalContacts || 0;
                    document.getElementById('totalInteractions').textContent = stats.totalInteractions || 0;
                    document.getElementById('newThisMonth').textContent = stats.newThisMonth || 0;
                    document.getElementById('avgLeadScore').textContent = (stats.avgLeadScore || 0).toFixed(1);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load contacts
        async function loadContacts(page = 1) {
            try {
                const token = localStorage.getItem('token');
                const contactType = document.getElementById('contactTypeFilter')?.value || '';
                const status = document.getElementById('statusFilter')?.value || '';

                let url = `${API_BASE}/crm/contacts?page=${page}&limit=21`;
                if (contactType) url += `&contactType=${contactType}`;
                if (status) url += `&status=${status}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                if (data.success) {
                    contactsData = data.contacts;
                    displayContacts(contactsData);
                    renderPagination('contacts', data.pagination);
                    currentPage = page;
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }

        // Display contacts
        function displayContacts(contacts) {
            const container = document.getElementById('contactsList');

            if (contacts.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center py-12"><p class="text-gray-400">No contacts found</p></div>';
                return;
            }

            container.innerHTML = contacts.map(contact => `
                <div class="contact-card" onclick="viewContact('${contact.id}')">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 rounded-full bg-cyan-400/20 flex items-center justify-center">
                                <i class="fas fa-user text-cyan-400"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-white">${contact.firstName} ${contact.lastName}</h3>
                                <p class="text-sm text-gray-400">${contact.organization || 'Individual'}</p>
                            </div>
                        </div>
                        <span class="badge badge-${contact.status}">${contact.status}</span>
                    </div>
                    <div class="space-y-1 text-sm">
                        ${contact.email ? `<p class="text-gray-300"><i class="fas fa-envelope mr-2 text-gray-500"></i>${contact.email}</p>` : ''}
                        ${contact.phone ? `<p class="text-gray-300"><i class="fas fa-phone mr-2 text-gray-500"></i>${contact.phone}</p>` : ''}
                        <p class="text-gray-400"><span class="badge badge-${contact.contactType} text-xs">${contact.contactType}</span></p>
                    </div>
                </div>
            `).join('');
        }

        // Load interactions
        async function loadInteractions(page = 1) {
            try {
                const token = localStorage.getItem('token');
                const type = document.getElementById('interactionTypeFilter')?.value || '';

                let url = `${API_BASE}/crm/interactions?page=${page}&limit=20`;
                if (type) url += `&type=${type}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                if (data.success) {
                    interactionsData = data.interactions;
                    displayInteractions(interactionsData);
                    renderPagination('interactions', data.pagination);
                }
            } catch (error) {
                console.error('Error loading interactions:', error);
            }
        }

        // Display interactions
        function displayInteractions(interactions) {
            const container = document.getElementById('interactionsList');

            if (interactions.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-8">No interactions found</p>';
                return;
            }

            container.innerHTML = interactions.map(interaction => `
                <div class="interaction-item">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="font-semibold text-white">${interaction.contact?.firstName || ''} ${interaction.contact?.lastName || ''}</span>
                                <span class="text-xs text-gray-500">•</span>
                                <span class="text-sm text-gray-400">${interaction.type.replace('_', ' ')}</span>
                                <span class="text-xs text-gray-500">•</span>
                                <span class="text-xs text-gray-500">${interaction.direction}</span>
                            </div>
                            ${interaction.subject ? `<p class="text-sm text-gray-300 mb-1">${interaction.subject}</p>` : ''}
                            ${interaction.content ? `<p class="text-xs text-gray-400">${interaction.content.substring(0, 100)}...</p>` : ''}
                        </div>
                        <span class="text-xs text-gray-500">${new Date(interaction.createdAt).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }

        // View contact details
        async function viewContact(id) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/crm/contacts/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                if (data.success) {
                    currentContact = data.contact;
                    displayContactDetail(currentContact);
                    document.getElementById('contactModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading contact:', error);
            }
        }

        // Display contact detail
        function displayContactDetail(contact) {
            document.getElementById('modalContactName').textContent = `${contact.firstName} ${contact.lastName}`;
            document.getElementById('modalContactType').textContent = `${contact.contactType} • ${contact.status}`;

            const info = document.getElementById('contactInfo');
            info.innerHTML = `
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 mb-2">Contact Information</h3>
                    <div class="space-y-2">
                        ${contact.email ? `<p class="text-white"><i class="fas fa-envelope mr-2 text-cyan-400"></i>${contact.email}</p>` : ''}
                        ${contact.phone ? `<p class="text-white"><i class="fas fa-phone mr-2 text-cyan-400"></i>${contact.phone}</p>` : ''}
                        ${contact.alternatePhone ? `<p class="text-white"><i class="fas fa-phone mr-2 text-gray-500"></i>${contact.alternatePhone}</p>` : ''}
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 mb-2">Organization</h3>
                    <div class="space-y-2 text-white">
                        ${contact.organization ? `<p>${contact.organization}</p>` : '<p class="text-gray-500">None</p>'}
                        ${contact.title ? `<p class="text-sm text-gray-300">${contact.title}</p>` : ''}
                    </div>
                </div>
                <div class="col-span-2">
                    <h3 class="text-sm font-semibold text-gray-400 mb-2">Address</h3>
                    <p class="text-white">
                        ${contact.address || ''} ${contact.city || ''}, ${contact.state || ''} ${contact.zipCode || ''}
                    </p>
                </div>
            `;

            // Load interactions for this contact
            loadContactInteractions(contact.id);
        }

        // Load contact interactions
        async function loadContactInteractions(contactId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/crm/interactions?contactId=${contactId}&limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                if (data.success) {
                    displayContactInteractions(data.interactions);
                }
            } catch (error) {
                console.error('Error loading contact interactions:', error);
            }
        }

        // Display contact interactions
        function displayContactInteractions(interactions) {
            const container = document.getElementById('contactInteractionsList');

            if (interactions.length === 0) {
                container.innerHTML = '<p class="text-gray-400">No interactions yet</p>';
                return;
            }

            container.innerHTML = interactions.map(interaction => `
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="bg-gray-800/50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-white">${interaction.type.replace('_', ' ')}</span>
                            <span class="text-xs text-gray-500">${new Date(interaction.createdAt).toLocaleString()}</span>
                        </div>
                        ${interaction.subject ? `<p class="text-sm text-gray-300 mb-1">${interaction.subject}</p>` : ''}
                        ${interaction.content ? `<p class="text-xs text-gray-400">${interaction.content}</p>` : ''}
                        <div class="flex items-center space-x-2 mt-2">
                            <span class="text-xs px-2 py-1 rounded bg-${interaction.outcome === 'successful' ? 'green' : 'yellow'}-900/30 text-${interaction.outcome === 'successful' ? 'green' : 'yellow'}-400">
                                ${interaction.outcome}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Create contact
        async function createContact() {
            const contactData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                contactType: document.getElementById('contactType').value,
                organization: document.getElementById('organization').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                zipCode: document.getElementById('zipCode').value,
                notes: document.getElementById('notes').value
            };

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/crm/contacts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(contactData)
                });

                const data = await response.json();
                if (data.success) {
                    alert('Contact created successfully!');
                    closeModal('createContactModal');
                    document.getElementById('contactForm').reset();
                    await loadContacts();
                    await loadStats();
                }
            } catch (error) {
                console.error('Error creating contact:', error);
                alert('Failed to create contact');
            }
        }

        // Log interaction
        async function logInteraction() {
            const interactionData = {
                type: document.getElementById('interactionType').value,
                direction: document.getElementById('interactionDirection').value,
                subject: document.getElementById('interactionSubject').value,
                content: document.getElementById('interactionContent').value,
                outcome: document.getElementById('interactionOutcome').value
            };

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/crm/contacts/${currentContact.id}/interactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(interactionData)
                });

                const data = await response.json();
                if (data.success) {
                    alert('Interaction logged successfully!');
                    closeModal('logInteractionModal');
                    document.getElementById('interactionForm').reset();
                    await loadContactInteractions(currentContact.id);
                    await loadStats();
                }
            } catch (error) {
                console.error('Error logging interaction:', error);
                alert('Failed to log interaction');
            }
        }

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            document.querySelectorAll('[id^="content-"]').forEach(content => content.classList.add('hidden'));
            document.getElementById(`content-${tab}`).classList.remove('hidden');
        }

        function switchContactTab(tab) {
            currentContactTab = tab;

            document.querySelectorAll('[id^="contact-tab-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`contact-tab-${tab}`).classList.add('active');

            document.querySelectorAll('[id^="contact-content-"]').forEach(content => content.classList.add('hidden'));
            document.getElementById(`contact-content-${tab}`).classList.remove('hidden');
        }

        // Search and filter
        function searchContacts() {
            const query = document.getElementById('searchContacts').value.toLowerCase();
            const filtered = contactsData.filter(contact =>
                `${contact.firstName} ${contact.lastName}`.toLowerCase().includes(query) ||
                contact.email?.toLowerCase().includes(query) ||
                contact.organization?.toLowerCase().includes(query)
            );
            displayContacts(filtered);
        }

        function filterContacts() {
            loadContacts(1);
        }

        function filterInteractions() {
            loadInteractions(1);
        }

        // Pagination
        function renderPagination(type, pagination) {
            const container = document.getElementById(`${type}Pagination`);
            const { page, totalPages } = pagination;

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = `
                <button onclick="load${type.charAt(0).toUpperCase() + type.slice(1)}(${page - 1})"
                        class="px-3 py-1 rounded border border-gray-600 hover:border-cyan-400 ${page === 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${page === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;

            for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
                html += `
                    <button onclick="load${type.charAt(0).toUpperCase() + type.slice(1)}(${i})"
                            class="px-4 py-1 rounded ${i === page ? 'bg-cyan-600' : 'border border-gray-600 hover:border-cyan-400'}">
                        ${i}
                    </button>
                `;
            }

            html += `
                <button onclick="load${type.charAt(0).toUpperCase() + type.slice(1)}(${page + 1})"
                        class="px-3 py-1 rounded border border-gray-600 hover:border-cyan-400 ${page === totalPages ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${page === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;

            container.innerHTML = html;
        }

        // Export contacts
        async function exportContacts() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/crm/export`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const csv = await response.text();
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `contacts-export-${Date.now()}.csv`;
                a.click();
            } catch (error) {
                console.error('Error exporting contacts:', error);
                alert('Failed to export contacts');
            }
        }

        // CSV Import
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                document.getElementById('csvPreviewText').textContent = text.substring(0, 500) + '...';
                document.getElementById('importPreview').classList.remove('hidden');
                document.getElementById('importButton').disabled = false;
                document.getElementById('importButton').classList.remove('opacity-50');

                // Parse CSV
                const lines = text.split('\n');
                const headers = lines[0].split(',');
                csvData = lines.slice(1).map(line => {
                    const values = line.split(',');
                    const obj = {};
                    headers.forEach((header, i) => {
                        obj[header.trim()] = values[i]?.trim();
                    });
                    return obj;
                });
            };
            reader.readAsText(file);
        }

        async function importCSV() {
            if (!csvData) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/crm/import`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ csvData })
                });

                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    closeModal('importModal');
                    await loadContacts();
                    await loadStats();
                }
            } catch (error) {
                console.error('Error importing contacts:', error);
                alert('Failed to import contacts');
            }
        }

        // Modal management
        function showCreateContactModal() {
            document.getElementById('createContactModal').classList.remove('hidden');
        }

        function showLogInteractionModal() {
            document.getElementById('logInteractionModal').classList.remove('hidden');
        }

        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function editContact() {
            alert('Edit functionality would open the contact form with current data');
        }

        function findDuplicates() {
            alert('Duplicate detection would search for similar contacts');
        }

        function archiveContact() {
            if (confirm('Archive this contact?')) {
                alert('Contact would be archived');
            }
        }
    </script>
</body>
</html>
