<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FOIA Management - Govli AI Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
    <script>
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0]?.includes?.('cdn.tailwindcss.com should not be used in production')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
        })();
    </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #0284c7;
      --primary-dark: #0369a1;
      --secondary: #14b8a6;
      --background: #0f172a;
      --surface: #1e293b;
      --text: #f1f5f9;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .glass {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(6, 182, 212, 0.2);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }

    .glass-hover:hover {
      background: rgba(30, 41, 59, 0.8);
      border-color: rgba(6, 182, 212, 0.4);
      transform: translateY(-2px);
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(6, 182, 212, 0.5);
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(20, 184, 166, 0.1) 100%);
      border: 1px solid rgba(6, 182, 212, 0.3);
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-submitted { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .status-acknowledged { background: rgba(6, 182, 212, 0.2); color: #14b8a6; }
    .status-assigned { background: rgba(168, 85, 247, 0.2); color: #a78bfa; }
    .status-records_gathering { background: rgba(234, 179, 8, 0.2); color: #facc15; }
    .status-processing { background: rgba(249, 115, 22, 0.2); color: #fb923c; }
    .status-redaction { background: rgba(217, 70, 239, 0.2); color: #d946ef; }
    .status-legal_review { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .status-ready_release { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .status-released { background: rgba(16, 185, 129, 0.2); color: #34d399; }
    .status-closed { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
    .status-denied { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

    .priority-low { color: #9ca3af; }
    .priority-normal { color: #60a5fa; }
    .priority-high { color: #facc15; }
    .priority-urgent { color: #f87171; }

    .tab-button {
      padding: 0.75rem 1.5rem;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .tab-button.active {
      border-bottom-color: var(--primary);
      color: var(--primary);
    }

    .tab-button:hover {
      background: rgba(6, 182, 212, 0.1);
    }

    .input-field {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(6, 182, 212, 0.3);
      color: var(--text);
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    .request-card {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .request-card:hover {
      transform: translateX(4px);
      border-color: rgba(6, 182, 212, 0.5);
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="glass fixed top-0 left-0 right-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-3">
          <i class="fas fa-file-alt text-3xl text-cyan-400"></i>
          <span class="text-xl font-bold">Govli AI</span>
          <span class="text-cyan-400">|</span>
          <span class="text-sm text-gray-400">FOIA Management</span>
        </div>
        <div class="flex items-center space-x-4">
          <button onclick="window.location.href='index.html'" class="text-gray-300 hover:text-white">
            <i class="fas fa-home mr-2"></i>Portal Hub
          </button>
          <button onclick="window.location.href='foia-citizen-portal.html'" class="text-gray-300 hover:text-white">
            <i class="fas fa-users mr-2"></i>Public Portal
          </button>
          <button onclick="logout()" class="text-gray-300 hover:text-white">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="pt-24 pb-12 px-4">
    <div class="max-w-7xl mx-auto">

      <!-- Stats Cards -->
      <div class="grid grid-cols-4 gap-6 mb-8">
        <div class="glass rounded-xl p-6">
          <div class="flex items-center justify-between mb-2">
            <i class="fas fa-inbox text-3xl text-blue-400"></i>
            <span id="totalRequests" class="text-3xl font-bold">0</span>
          </div>
          <p class="text-gray-400 text-sm">Total Requests</p>
        </div>
        <div class="glass rounded-xl p-6">
          <div class="flex items-center justify-between mb-2">
            <i class="fas fa-clock text-3xl text-yellow-400"></i>
            <span id="overdueCount" class="text-3xl font-bold">0</span>
          </div>
          <p class="text-gray-400 text-sm">Overdue</p>
        </div>
        <div class="glass rounded-xl p-6">
          <div class="flex items-center justify-between mb-2">
            <i class="fas fa-calendar-week text-3xl text-orange-400"></i>
            <span id="dueThisWeek" class="text-3xl font-bold">0</span>
          </div>
          <p class="text-gray-400 text-sm">Due This Week</p>
        </div>
        <div class="glass rounded-xl p-6">
          <div class="flex items-center justify-between mb-2">
            <i class="fas fa-check-circle text-3xl text-green-400"></i>
            <span id="completedCount" class="text-3xl font-bold">0</span>
          </div>
          <p class="text-gray-400 text-sm">Completed</p>
        </div>
      </div>

      <!-- Tabs -->
      <div class="glass rounded-t-xl">
        <div class="flex border-b border-gray-700">
          <button class="tab-button active" onclick="switchTab('requests')" id="tab-requests">
            <i class="fas fa-inbox mr-2"></i>Requests
          </button>
          <button class="tab-button" onclick="switchTab('documents')" id="tab-documents">
            <i class="fas fa-file-search mr-2"></i>Document Review
          </button>
          <button class="tab-button" onclick="switchTab('analytics')" id="tab-analytics">
            <i class="fas fa-chart-bar mr-2"></i>Analytics
          </button>
        </div>
      </div>

      <!-- Requests Tab -->
      <div id="content-requests" class="glass rounded-b-xl p-6">

        <!-- Filters -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold">Request Management</h2>
            <div class="flex items-center space-x-3">
              <input type="text" id="searchRequests" placeholder="Search requests..."
                     class="input-field px-4 py-2 rounded-lg w-64"
                     onkeyup="searchRequests()">
              <select id="statusFilter" class="input-field px-4 py-2 rounded-lg"
                      onchange="filterRequests()">
                <option value="">All Statuses</option>
                <option value="submitted">Submitted</option>
                <option value="acknowledged">Acknowledged</option>
                <option value="assigned">Assigned</option>
                <option value="records_gathering">Records Gathering</option>
                <option value="processing">Processing</option>
                <option value="redaction">Redaction</option>
                <option value="legal_review">Legal Review</option>
                <option value="ready_release">Ready for Release</option>
                <option value="released">Released</option>
                <option value="closed">Closed</option>
                <option value="denied">Denied</option>
              </select>
              <select id="priorityFilter" class="input-field px-4 py-2 rounded-lg"
                      onchange="filterRequests()">
                <option value="">All Priorities</option>
                <option value="low">Low</option>
                <option value="normal">Normal</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Requests List -->
        <div id="requestsList" class="space-y-4">
          <!-- Requests will be loaded here -->
        </div>

        <!-- Pagination -->
        <div id="requestsPagination" class="flex justify-center items-center space-x-2 mt-6">
          <!-- Pagination will be rendered here -->
        </div>

      </div>

      <!-- Document Review Tab -->
      <div id="content-documents" class="glass rounded-b-xl p-6 hidden">
        <div class="mb-6">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold">Document Classification & Redaction</h2>
            <button onclick="batchAnalyzeDocuments()" class="btn-primary px-4 py-2 rounded-lg">
              <i class="fas fa-magic mr-2"></i>Batch Analyze Pending
            </button>
          </div>
          <p class="text-gray-400 text-sm mt-2">AI-powered document classification, PII detection, and FOIA exemption analysis</p>
        </div>

        <!-- Documents List -->
        <div id="documentsList" class="space-y-4 mb-6">
          <!-- Documents will be loaded here -->
        </div>

        <!-- Document Analysis Modal (shown when viewing a document) -->
        <div id="analysisModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div class="glass rounded-xl max-w-6xl w-full max-h-screen overflow-y-auto p-6">

            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-2xl font-bold" id="modalDocumentTitle">Document Analysis</h3>
              <button onclick="closeAnalysisModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
              </button>
            </div>

            <!-- Analysis Summary -->
            <div id="analysisSummary" class="grid grid-cols-4 gap-4 mb-6">
              <!-- Summary cards will be rendered here -->
            </div>

            <!-- Document Type Classification -->
            <div class="glass rounded-lg p-4 mb-6">
              <h4 class="text-lg font-semibold mb-3 flex items-center">
                <i class="fas fa-file-alt text-cyan-400 mr-2"></i>
                Document Type
              </h4>
              <div id="documentTypeSection">
                <!-- Classification results -->
              </div>
            </div>

            <!-- Detected PII -->
            <div class="glass rounded-lg p-4 mb-6">
              <h4 class="text-lg font-semibold mb-3 flex items-center">
                <i class="fas fa-user-shield text-yellow-400 mr-2"></i>
                Detected PII & Redaction Suggestions
              </h4>
              <div id="detectedPIISection">
                <!-- PII detection results -->
              </div>
            </div>

            <!-- FOIA Exemptions -->
            <div class="glass rounded-lg p-4 mb-6">
              <h4 class="text-lg font-semibold mb-3 flex items-center">
                <i class="fas fa-balance-scale text-purple-400 mr-2"></i>
                FOIA Exemption Classifications
              </h4>
              <div id="exemptionsSection">
                <!-- Exemption classification results -->
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-3">
              <button onclick="closeAnalysisModal()" class="px-6 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">
                Close
              </button>
              <button onclick="applyRedactions()" class="btn-primary px-6 py-2 rounded-lg">
                <i class="fas fa-check mr-2"></i>Apply Approved Redactions
              </button>
            </div>

          </div>
        </div>

      </div>

      <!-- Analytics Tab -->
      <div id="content-analytics" class="glass rounded-b-xl p-6 hidden">
        <h2 class="text-xl font-bold mb-6">FOIA Analytics</h2>

        <div class="grid grid-cols-2 gap-6 mb-8">
          <!-- Status Distribution -->
          <div class="glass rounded-xl p-6">
            <h3 class="text-lg font-semibold mb-4">Requests by Status</h3>
            <div id="statusChart" class="space-y-3">
              <!-- Status breakdown will be rendered here -->
            </div>
          </div>

          <!-- Priority Distribution -->
          <div class="glass rounded-xl p-6">
            <h3 class="text-lg font-semibold mb-4">Requests by Priority</h3>
            <div id="priorityChart" class="space-y-3">
              <!-- Priority breakdown will be rendered here -->
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="glass rounded-xl p-6">
          <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
          <div id="recentActivity" class="space-y-3">
            <!-- Activity will be rendered here -->
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:3000';

    // State
    let currentPage = 1;
    let currentFilters = {
      status: '',
      priority: '',
      query: ''
    };

    // State for document analysis
    let currentAnalysisData = null;
    let currentDocumentId = null;
    let token = localStorage.getItem('govli_token');

    // Load dashboard statistics
    async function loadDashboardStats() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/foia/admin/dashboard`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        // Check for unauthorized
        if (response.status === 401 || response.status === 403) {
          console.error('Unauthorized access - redirecting to login');
          localStorage.removeItem('govli_token');
          window.location.href = 'index.html';
          return;
        }

        if (!response.ok) {
          console.warn('Failed to load stats - Status:', response.status, response.statusText);
          // Set default values
          document.getElementById('totalRequests').textContent = '0';
          document.getElementById('overdueCount').textContent = '0';
          document.getElementById('dueThisWeek').textContent = '0';
          document.getElementById('completedCount').textContent = '0';
          return;
        }

        const data = await response.json();
        const stats = data.stats;

        document.getElementById('totalRequests').textContent = stats.totalRequests || 0;
        document.getElementById('overdueCount').textContent = stats.overdue || 0;
        document.getElementById('dueThisWeek').textContent = stats.dueThisWeek || 0;

        // Calculate completed (released + closed)
        const completed = (stats.byStatus?.released || 0) + (stats.byStatus?.closed || 0);
        document.getElementById('completedCount').textContent = completed;

        // Render analytics charts
        renderStatusChart(stats.byStatus || {});
        renderPriorityChart(stats.byPriority || {});
      } catch (error) {
        console.warn('Error loading stats - page will continue to function:', error);
        // Set default values on error
        document.getElementById('totalRequests').textContent = '0';
        document.getElementById('overdueCount').textContent = '0';
        document.getElementById('dueThisWeek').textContent = '0';
        document.getElementById('completedCount').textContent = '0';
      }
    }

    // Load requests
    async function loadRequests(page = 1) {
      try {
        const params = new URLSearchParams({
          page,
          limit: 20,
          ...currentFilters
        });

        const response = await fetch(`${API_BASE_URL}/api/foia/admin/requests?${params}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        // Check for unauthorized
        if (response.status === 401 || response.status === 403) {
          console.error('Unauthorized access - redirecting to login');
          localStorage.removeItem('govli_token');
          window.location.href = 'index.html';
          return;
        }

        if (!response.ok) {
          console.error('Failed to load requests - Status:', response.status, response.statusText);
          throw new Error(`Failed to load requests: ${response.statusText}`);
        }

        const data = await response.json();
        renderRequests(data.requests);
        renderPagination(data.pagination);
      } catch (error) {
        console.error('Error loading requests:', error);
        document.getElementById('requestsList').innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
            <p>Failed to load requests</p>
            <p class="text-sm mt-2">${error.message || 'Please check your connection and try again'}</p>
          </div>
        `;
      }
    }

    // Render requests
    function renderRequests(requests) {
      const container = document.getElementById('requestsList');

      if (requests.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <i class="fas fa-inbox text-4xl mb-2"></i>
            <p>No requests found</p>
          </div>
        `;
        return;
      }

      container.innerHTML = requests.map(request => `
        <div class="glass rounded-lg p-4 request-card border border-gray-700"
             onclick="viewRequest('${request.id}')">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center space-x-3 mb-2">
                <span class="font-mono text-sm text-cyan-400">${request.trackingNumber}</span>
                <span class="status-badge status-${request.status}">
                  ${formatStatus(request.status)}
                </span>
                <span class="priority-${request.priority}">
                  <i class="fas fa-flag mr-1"></i>${request.priority}
                </span>
              </div>
              <h3 class="text-lg font-semibold mb-1">${request.subject}</h3>
              <p class="text-sm text-gray-400 mb-2">${truncate(request.description, 100)}</p>
              <div class="flex items-center space-x-4 text-sm text-gray-500">
                <span><i class="fas fa-user mr-1"></i>${request.requesterName}</span>
                <span><i class="fas fa-calendar mr-1"></i>Submitted ${formatDate(request.dateSubmitted)}</span>
                ${request.dateDue ? `<span><i class="fas fa-clock mr-1"></i>Due ${formatDate(request.dateDue)}</span>` : ''}
                ${request.assignedStaff ? `<span><i class="fas fa-user-tie mr-1"></i>${request.assignedStaff.name}</span>` : ''}
              </div>
            </div>
            <div class="ml-4">
              <i class="fas fa-chevron-right text-gray-500"></i>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Render pagination
    function renderPagination(pagination) {
      const container = document.getElementById('requestsPagination');
      if (!pagination || pagination.totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      const pages = [];
      for (let i = 1; i <= pagination.totalPages; i++) {
        if (i === 1 || i === pagination.totalPages || Math.abs(i - pagination.page) <= 2) {
          pages.push(i);
        } else if (pages[pages.length - 1] !== '...') {
          pages.push('...');
        }
      }

      container.innerHTML = pages.map(page => {
        if (page === '...') {
          return '<span class="px-3 py-1 text-gray-500">...</span>';
        }
        const isActive = page === pagination.page;
        return `
          <button
            onclick="loadRequests(${page})"
            class="px-3 py-1 rounded ${isActive ? 'bg-cyan-600 text-white' : 'text-gray-400 hover:text-white'}">
            ${page}
          </button>
        `;
      }).join('');
    }

    // Render status chart
    function renderStatusChart(statusData) {
      const container = document.getElementById('statusChart');
      const total = Object.values(statusData).reduce((a, b) => a + b, 0) || 1;

      container.innerHTML = Object.entries(statusData).map(([status, count]) => {
        const percentage = ((count / total) * 100).toFixed(1);
        return `
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-400">${formatStatus(status)}</span>
              <span class="text-white font-semibold">${count}</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
              <div class="bg-cyan-500 h-2 rounded-full" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Render priority chart
    function renderPriorityChart(priorityData) {
      const container = document.getElementById('priorityChart');
      const total = Object.values(priorityData).reduce((a, b) => a + b, 0) || 1;

      container.innerHTML = Object.entries(priorityData).map(([priority, count]) => {
        const percentage = ((count / total) * 100).toFixed(1);
        return `
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-400">${priority}</span>
              <span class="text-white font-semibold">${count}</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
              <div class="bg-purple-500 h-2 rounded-full" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Tab switching
    function switchTab(tab) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('[id^="content-"]').forEach(content => content.classList.add('hidden'));

      document.getElementById(`tab-${tab}`).classList.add('active');
      document.getElementById(`content-${tab}`).classList.remove('hidden');
    }

    // Search and filter
    function searchRequests() {
      currentFilters.query = document.getElementById('searchRequests').value;
      loadRequests(1);
    }

    function filterRequests() {
      currentFilters.status = document.getElementById('statusFilter').value;
      currentFilters.priority = document.getElementById('priorityFilter').value;
      loadRequests(1);
    }

    // View request details
    function viewRequest(id) {
      window.location.href = `foia-request-detail.html?id=${id}`;
    }

    // Utility functions
    function formatStatus(status) {
      return status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString();
    }

    function truncate(str, length) {
      return str.length > length ? str.substring(0, length) + '...' : str;
    }

    function logout() {
      localStorage.removeItem('govli_token');
      window.location.href = 'login.html';
    }

    // ========================================
    // DOCUMENT ANALYSIS FUNCTIONS
    // ========================================

    // Load documents for analysis
    async function loadDocuments() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/foia/admin/documents`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load documents');

        const data = await response.json();
        renderDocuments(data.documents || []);
      } catch (error) {
        console.error('Error loading documents:', error);
        document.getElementById('documentsList').innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
            <p>Failed to load documents</p>
          </div>
        `;
      }
    }

    // Render documents list
    function renderDocuments(documents) {
      const container = document.getElementById('documentsList');

      if (documents.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <i class="fas fa-file text-4xl mb-2"></i>
            <p>No documents found</p>
          </div>
        `;
        return;
      }

      container.innerHTML = documents.map(doc => {
        const statusColor = doc.analysis?.processingStatus === 'completed' ? 'green' :
                          doc.analysis?.processingStatus === 'processing' ? 'yellow' :
                          doc.analysis?.processingStatus === 'failed' ? 'red' : 'gray';

        return `
          <div class="glass rounded-lg p-4 border border-gray-700">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="flex items-center space-x-3 mb-2">
                  <i class="fas fa-file-pdf text-2xl text-red-400"></i>
                  <div>
                    <h3 class="font-semibold">${doc.fileName}</h3>
                    <p class="text-sm text-gray-400">Request: ${doc.request?.trackingNumber || 'N/A'}</p>
                  </div>
                </div>
                <div class="flex items-center space-x-4 text-sm text-gray-500">
                  <span><i class="fas fa-calendar mr-1"></i>${formatDate(doc.uploadedAt)}</span>
                  ${doc.analysis ? `
                    <span class="text-${statusColor}-400">
                      <i class="fas fa-brain mr-1"></i>
                      ${formatStatus(doc.analysis.processingStatus)}
                    </span>
                    ${doc.analysis.documentType ? `
                      <span><i class="fas fa-tag mr-1"></i>${doc.analysis.documentType}</span>
                    ` : ''}
                  ` : '<span class="text-gray-500"><i class="fas fa-circle mr-1"></i>Not analyzed</span>'}
                </div>
              </div>
              <div class="flex items-center space-x-2">
                ${doc.analysis?.processingStatus === 'completed' ? `
                  <button onclick='viewAnalysis("${doc.id}")' class="px-4 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-500">
                    <i class="fas fa-eye mr-2"></i>View Analysis
                  </button>
                ` : `
                  <button onclick='analyzeDocument("${doc.id}")' class="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-500">
                    <i class="fas fa-magic mr-2"></i>Analyze
                  </button>
                `}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Analyze a single document
    async function analyzeDocument(documentId) {
      try {
        // Show loading state
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...';
        btn.disabled = true;

        // For demo: use placeholder text
        // In production, you would extract text from the PDF
        const documentText = `Sample document text for analysis. This is a memorandum from John Doe to Jane Smith.

        Subject: Quarterly Report

        Dear Jane,

        This is to inform you about our quarterly results. Please find the details below.

        Contact: john.doe@example.com
        Phone: 555-123-4567
        SSN: 123-45-6789

        Classified information regarding national security operations.

        Best regards,
        John Doe`;

        const response = await fetch(`${API_BASE_URL}/api/foia/admin/documents/${documentId}/analyze`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            documentText,
            pageCount: 1
          })
        });

        if (!response.ok) throw new Error('Analysis failed');

        const data = await response.json();

        // Reload documents to show updated status
        await loadDocuments();

        // Show success message
        alert('Document analyzed successfully! Click "View Analysis" to see results.');
      } catch (error) {
        console.error('Error analyzing document:', error);
        alert('Failed to analyze document: ' + error.message);
        btn.innerHTML = originalHTML;
        btn.disabled = false;
      }
    }

    // View analysis results
    async function viewAnalysis(documentId) {
      try {
        currentDocumentId = documentId;

        const response = await fetch(`${API_BASE_URL}/api/foia/admin/documents/${documentId}/analysis`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load analysis');

        const data = await response.json();
        currentAnalysisData = data.analysis;

        renderAnalysisModal(data.analysis);
        document.getElementById('analysisModal').classList.remove('hidden');
      } catch (error) {
        console.error('Error loading analysis:', error);
        alert('Failed to load analysis: ' + error.message);
      }
    }

    // Render analysis modal
    function renderAnalysisModal(analysis) {
      if (!analysis) return;

      // Summary cards
      document.getElementById('analysisSummary').innerHTML = `
        <div class="glass rounded-lg p-4">
          <div class="text-3xl font-bold text-cyan-400">${analysis.documentType || 'unknown'}</div>
          <div class="text-sm text-gray-400">Document Type</div>
          <div class="text-xs text-gray-500 mt-1">${Math.round((analysis.typeConfidence || 0) * 100)}% confidence</div>
        </div>
        <div class="glass rounded-lg p-4">
          <div class="text-3xl font-bold text-yellow-400">${analysis.detectedPII?.length || 0}</div>
          <div class="text-sm text-gray-400">PII Detected</div>
          <div class="text-xs text-gray-500 mt-1">Requires redaction</div>
        </div>
        <div class="glass rounded-lg p-4">
          <div class="text-3xl font-bold text-purple-400">${analysis.exemptions?.length || 0}</div>
          <div class="text-sm text-gray-400">Exemptions</div>
          <div class="text-xs text-gray-500 mt-1">FOIA classifications</div>
        </div>
        <div class="glass rounded-lg p-4">
          <div class="text-3xl font-bold text-green-400">${analysis.metadata?.processingTimeMs || 0}ms</div>
          <div class="text-sm text-gray-400">Processing Time</div>
          <div class="text-xs text-gray-500 mt-1">Analysis speed</div>
        </div>
      `;

      // Document type section
      document.getElementById('documentTypeSection').innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <span class="text-2xl font-bold text-cyan-400">${analysis.documentType || 'unknown'}</span>
            <span class="text-gray-400 ml-3">${Math.round((analysis.typeConfidence || 0) * 100)}% confidence</span>
          </div>
          <div class="px-4 py-2 rounded-lg bg-cyan-900 bg-opacity-30 border border-cyan-600">
            <i class="fas fa-check-circle text-cyan-400 mr-2"></i>Classified
          </div>
        </div>
      `;

      // PII section
      const piiHTML = (analysis.detectedPII || []).map(pii => `
        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 mb-3">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center space-x-3 mb-2">
                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-900 bg-opacity-30 text-yellow-400 border border-yellow-600">
                  ${pii.type}
                </span>
                <span class="text-sm text-gray-400">${Math.round(pii.confidence * 100)}% confidence</span>
                ${pii.redactionSuggestion ? `
                  <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                    pii.redactionSuggestion.status === 'approved' ? 'bg-green-900 bg-opacity-30 text-green-400 border border-green-600' :
                    pii.redactionSuggestion.status === 'rejected' ? 'bg-red-900 bg-opacity-30 text-red-400 border border-red-600' :
                    'bg-blue-900 bg-opacity-30 text-blue-400 border border-blue-600'
                  }">
                    ${pii.redactionSuggestion.status}
                  </span>
                ` : ''}
              </div>
              <div class="text-sm text-gray-300 mb-2">
                <span class="font-mono bg-gray-900 px-2 py-1 rounded">${escapeHtml(pii.context || 'No context available')}</span>
              </div>
              ${pii.redactionSuggestion ? `
                <div class="text-xs text-gray-400">
                  <i class="fas fa-info-circle mr-1"></i>
                  <strong>Method:</strong> ${pii.redactionSuggestion.method || 'black_box'} |
                  <strong>Reason:</strong> ${pii.redactionSuggestion.reason || 'Privacy protection'}
                </div>
              ` : ''}
            </div>
            ${pii.redactionSuggestion && pii.redactionSuggestion.status === 'suggested' ? `
              <div class="flex space-x-2 ml-4">
                <button onclick='toggleRedactionStatus("${pii.redactionSuggestion.id}", "approved")' class="px-3 py-1 rounded bg-green-600 hover:bg-green-500 text-sm">
                  <i class="fas fa-check"></i>
                </button>
                <button onclick='toggleRedactionStatus("${pii.redactionSuggestion.id}", "rejected")' class="px-3 py-1 rounded bg-red-600 hover:bg-red-500 text-sm">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            ` : ''}
          </div>
        </div>
      `).join('');

      document.getElementById('detectedPIISection').innerHTML = piiHTML ||
        '<p class="text-gray-400">No PII detected in this document.</p>';

      // Exemptions section
      const exemptionsHTML = (analysis.exemptions || []).map(ex => `
        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 mb-3">
          <div class="flex items-center justify-between">
            <div>
              <div class="flex items-center space-x-3 mb-2">
                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-purple-900 bg-opacity-30 text-purple-400 border border-purple-600">
                  Exemption ${ex.type.toUpperCase()}
                </span>
                <span class="text-lg font-semibold">${ex.name}</span>
                <span class="text-sm text-gray-400">${Math.round(ex.confidence * 100)}% confidence</span>
              </div>
              <p class="text-sm text-gray-400">${ex.reasoning}</p>
            </div>
            <span class="px-4 py-2 rounded-lg ${
              ex.status === 'approved' ? 'bg-green-900 bg-opacity-30 text-green-400 border border-green-600' :
              ex.status === 'rejected' ? 'bg-red-900 bg-opacity-30 text-red-400 border border-red-600' :
              'bg-blue-900 bg-opacity-30 text-blue-400 border border-blue-600'
            }">
              ${ex.status}
            </span>
          </div>
        </div>
      `).join('');

      document.getElementById('exemptionsSection').innerHTML = exemptionsHTML ||
        '<p class="text-gray-400">No FOIA exemptions suggested for this document.</p>';
    }

    // Toggle redaction status
    async function toggleRedactionStatus(redactionId, newStatus) {
      try {
        // Update UI optimistically
        const redactionElement = event.target.closest('.bg-gray-800');
        const statusBadge = redactionElement.querySelector('.px-3.py-1.rounded-full:last-of-type');

        // Update local data
        if (currentAnalysisData && currentAnalysisData.detectedPII) {
          for (const pii of currentAnalysisData.detectedPII) {
            if (pii.redactionSuggestion?.id === redactionId) {
              pii.redactionSuggestion.status = newStatus;
              break;
            }
          }
        }

        // Re-render to update UI
        renderAnalysisModal(currentAnalysisData);
      } catch (error) {
        console.error('Error toggling redaction status:', error);
      }
    }

    // Apply approved redactions
    async function applyRedactions() {
      try {
        if (!currentAnalysisData || !currentDocumentId) return;

        // Collect approved redaction IDs
        const approvedRedactionIds = [];
        if (currentAnalysisData.detectedPII) {
          for (const pii of currentAnalysisData.detectedPII) {
            if (pii.redactionSuggestion?.status === 'approved') {
              approvedRedactionIds.push(pii.redactionSuggestion.id);
            }
          }
        }

        if (approvedRedactionIds.length === 0) {
          alert('No redactions have been approved. Please approve at least one redaction suggestion.');
          return;
        }

        const response = await fetch(`${API_BASE_URL}/api/foia/admin/documents/${currentDocumentId}/apply-redactions`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ approvedRedactionIds })
        });

        if (!response.ok) throw new Error('Failed to apply redactions');

        const data = await response.json();
        alert(`Success! ${data.approvedCount} redaction(s) have been approved for processing.`);

        closeAnalysisModal();
        loadDocuments();
      } catch (error) {
        console.error('Error applying redactions:', error);
        alert('Failed to apply redactions: ' + error.message);
      }
    }

    // Batch analyze documents
    async function batchAnalyzeDocuments() {
      try {
        if (!confirm('Analyze all pending documents? This may take a few minutes.')) return;

        const btn = event.target;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        btn.disabled = true;

        // Get all unanalyzed documents
        const response = await fetch(`${API_BASE_URL}/api/foia/admin/documents`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load documents');

        const data = await response.json();
        const pendingDocs = (data.documents || []).filter(doc => !doc.analysis);

        if (pendingDocs.length === 0) {
          alert('No pending documents to analyze!');
          btn.innerHTML = originalHTML;
          btn.disabled = false;
          return;
        }

        // Batch analyze
        const batchResponse = await fetch(`${API_BASE_URL}/api/foia/admin/documents/batch-analyze`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            documents: pendingDocs.map(doc => ({
              documentId: doc.id,
              documentText: 'Sample text for batch analysis' // In production, extract from PDF
            }))
          })
        });

        if (!batchResponse.ok) throw new Error('Batch analysis failed');

        const batchData = await batchResponse.json();
        alert(`Batch analysis complete!\n\nProcessed: ${batchData.processed}\nFailed: ${batchData.failed}`);

        loadDocuments();
        btn.innerHTML = originalHTML;
        btn.disabled = false;
      } catch (error) {
        console.error('Error in batch analysis:', error);
        alert('Batch analysis failed: ' + error.message);
        btn.innerHTML = originalHTML;
        btn.disabled = false;
      }
    }

    // Close analysis modal
    function closeAnalysisModal() {
      document.getElementById('analysisModal').classList.add('hidden');
      currentAnalysisData = null;
      currentDocumentId = null;
    }

    // Escape HTML for security
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Update tab switcher to load documents when switching to documents tab
    const originalSwitchTab = switchTab;
    switchTab = function(tab) {
      originalSwitchTab(tab);
      if (tab === 'documents') {
        loadDocuments();
      }
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      // Check authentication
      if (!token) {
        console.log('No token found, attempting auto-login...');
        try {
          const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: 'admin@govli.ai', password: 'admin123' })
          });
          const data = await response.json();
          if (data.token) {
            token = data.token;
            localStorage.setItem('govli_token', token);
            console.log('Auto-login successful!');
            // Continue with initialization
          } else {
            alert('Auto-login failed. Please login manually at login.html');
            return;
          }
        } catch (error) {
          console.error('Auto-login error:', error);
          alert('Could not connect to backend. Please check if the server is running.');
          return;
        }
      }

      // Load initial data
      loadDashboardStats();
      loadRequests();
    });
  </script>
</body>
</html>
